| UID | Issue | Description & Justification | Specific fix | Done? | Comments |
|-----|-------|---------------------------|-------------|-------|----------|
| T‑001 | Fatal import‑time sys.exit(1) on missing libs | get_sensing_data.py aborts when pandas / sqlalchemy / python‑dotenv are absent, so the whole test run dies before any patching can happen (e.g. in a clean CI container). | get_sensing_data.py → 19‑27 ‑ Replace the print + sys.exit(1) block with raise ImportError or move the heavy imports inside main(). | | |
| T‑002 | Deprecated unittest.makeSuite & manual suite | run_tests.py hand‑builds a suite with makeSuite, which is deprecated in Python 3.13 and silently ignores new test classes. | run_tests.py → 22‑25 ‑ Replace with unittest.defaultTestLoader.discover(start_dir=os.path.dirname(__file__)) or delete the file and rely on python -m unittest discover/pytest. | | |
| T‑003 | Re‑adding project root to sys.path in every test | Lines like sys.path.insert(0, …) appear in all four test files, masking real import errors and polluting the path. | Remove these lines:<br>• test_cli.py → 11‑13<br>• test_credentials.py → 11‑13<br>• test_database.py → 10‑12<br>• test_file_operations.py → 13‑15<br>Package the code or run tests from repo root instead. | | |
| T‑004 | CLI tests don't exercise the parser | test_cli.py patches ArgumentParser.parse_args, so no flag/validation logic is executed. Parser bugs will slip through. | Rewrite tests at test_cli.py → 18‑63, 65‑110, 112‑144 to call:<br>parser = get_sensing_data.build_parser() (or expose one) and parser.parse_args([...]) or run subprocess.run(['python', 'get_sensing_data.py', …]) in an integration test. | | |
| T‑005 | No negative/edge‑case CLI coverage | Missing tests for --help, bad date formats, mutually‑exclusive flags, etc. | Add new test functions below test_cli.py → 146 covering: invalid date, missing required arg and --help exit code. | | |
| T‑006 | SQL text never verified | In test_database.test_list_available_projects we mock text() but never assert the SQL; retry logic isn't exercised either. | • test_database.py → 55‑66 ‑ Assert mock_text.assert_called_once_with(expected_sql).<br>• Add a parametric test after line 75 that raises OperationalError twice to hit the back‑off branch. | | |
| T‑007 | Connection‑error branches untested | create_engine_from_credentials has rich error logging but no tests trigger it. | Add new tests after test_database.py → 44 that raise sqlalchemy.exc.OperationalError / ProgrammingError via patch('get_sensing_data.create_engine'). | | |
| T‑008 | Metadata integrity not asserted | test_save_data_with_zip only checks that a file containing "metadata" is in the zip – not its contents or the SHA‑256 value. | test_file_operations.py → 141‑146 ‑ Open the metadata member inside the zip, read the hash line, recompute the hash and assert equality. | | |
| T‑009 | Parquet path skipped if pyarrow absent | The Parquet test is silently skipped, leaving the branch untested in most CI images. | test_file_operations.py → 95‑121 ‑ Use patch.dict('sys.modules', {'pyarrow': MagicMock()}) to stub pyarrow so the test always runs. | | |
| T‑010 | Only tiny file tested for hashing | calculate_file_hash is exercised with a 23‑byte file; multi‑chunk reads and error handling aren't covered. | Add new cases after test_file_operations.py → 69:<br>• 5 MB temp file to hit multiple read iterations.<br>• Non‑existent path expecting FileNotFoundError. | | |
| T‑011 | Node‑ID parsing assertion is superficial | The test just inspects the kwargs of a mocked get_raw_data, not the actual CLI split logic. | test_cli.py → 112‑144 ‑ Stop patching get_raw_data, invoke CLI with --node-id node1,node2, and assert that logger.info shows the split list or that the real function receives the list. | | |
| T‑012 | Patch leakage between tests | Several tests patch get_sensing_data.logger without autospec and outside fixtures, risking residual state. | Convert logger patches to @patch('get_sensing_data.logger', autospec=True) inside class‑level setUp/tearDown blocks (e.g. test_cli.py → 37‑43, test_file_operations.py → 71). | | |
| T‑013 | Manual suite hides new tests | If someone adds a new test file/class and forgets to edit run_tests.py, it will never run. | Same fix as T‑002 (delete or auto‑discover). | | |
| T‑014 | Verbose flag path untested | No test sets --verbose; debug‑level branches could break silently. | Add a test after test_cli.py → 146 that calls CLI with --verbose and asserts logger.setLevel got DEBUG. | | |
| T‑015 | No test for temp‑file cleanup | save_data should remove the temp file and (optionally) metadata file; this isn't verified. | Extend test_file_operations.py → 75‑88 and 141‑146 to assert not os.path.exists(temp_file) and (when zipped) metadata file removal. | | |